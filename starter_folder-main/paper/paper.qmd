---
title: "E. coli Testing: Safeguarding Public Health"
author: 
  - Tianrui Fu
thanks: "Code and data are available at: LINK."
date: today
date-format: long
abstract: "Swimming in beaches with high E. coli levels can lead to gastrointestinal issues, rashes, and infections, particularly affecting young children, the elderly, and those with weakened immune systems. In 1998, the implementation of the Ministry of Health Beach Management Protocol project led the Toronto department to start collecting beach water quality data in 2007, aiming to reduce the incidence of waterborne diseases in the population. Third sentence. Fourth sentence."
format: pdf
number-sections: true
bibliography: references.bib
---

```{r}
#| include: false
#| warning: false
#| message: false

library(tidyverse)
library(palmerpenguins)
```

# Introduction

The increase in E. coli concentration is a serious problem for humans. Elevated concentrations make beach water unsafe, hindering safe human use. Although some strains of E. coli are harmless, pathogenic microorganisms may still be present. In cases of increased concentration, healthy individuals among those infected can recover on their own; however, vulnerable populations such as children, the elderly, and those with compromised immune systems may suffer more severe illnesses, including general gastrointestinal discomfort, rashes, ear and eye infections, and in severe cases, bloody diarrhea, kidney failure, and death. The rise in E. coli concentration is caused by various factors, such as the runoff of animal feces carrying pathogens from land or sewage systems, aging sewage pipelines, and wastewater infrastructure issues. Considering the rapid growth of E. coli and the associated public health risks, real-time monitoring of beach water quality is essential.

According to the requirements of the Ministry of Health Beach Management Protocol (January 1, 1998), the Beach Water Sampling Program for the City of Toronto was implemented to reduce the incidence of waterborne diseases. Toronto's beaches have been certified under the Blue Flag program. From June to September each year, the relevant departments in Toronto collect water samples daily from all regulated beaches in the city to test for E. coli bacteria concentrations.

The number of E. coli in freshwater is determined by counting the number of yellow and yellow-brown colonies that grow after placing a 0.45-micron filter on m-TEC medium and incubating it at 35.0ºC for 22-24 hours. The water quality standard for E. coli in Ontario and federally is 200 E. coli per 100 milliliters of water, while Toronto's beach water quality standard is 100 E. coli per 100 milliliters of water. This article utilizes 22,000 data points collected by government departments from June to September from 2007 to 2024 to assess...

# Data {#sec-data}

## Raw Data
The data used in this paper is from Open Data Toronto and download by the opendatatoronto library. The dataset is used to analyze whether the E.coli value in the beach during June and September is satisfy for people to swim. All the data analysis is through the @citeR 及以下软件包完成的：@tidyverse, @tinytex, @dplyr, @janitor, @ggplot2, @here, @kableExtra and @knitr.
The dataset is published by Toronto Public Health and is part of The Beach Water Sampling Program, which collects E. coli values from two different beaches. The data is updated daily, and the data used for this analysis spans from June 3, 2007, to September 8, 2024. The raw dataset contains 21,882 water quality samples testing for E. coli concentrations. The dataset also includes beach itendifiers, names, sample site names, collection dates for each sample, and geographic coordinates (latitude and longitude).

## Cleaned Data
In the raw data provided by Toronto Public Health, there were missing values (NA). During the data cleaning process, rows containing these NA values were completely removed to ensure that the NA values would not affect the analysis output and to simplify the analysis. Since the raw data also contained some particularly large outlier values, those were also removed. The cleaned data only includes the necessary columns for analysis, such as collection date, E. coli, site name, and beach name. Figure 1 shows the cleaned data samples, listing the results of tests conducted at different locations on the same day.
```{r}
#| include: false
#| warning: false
#| message: false

#### Download library ####
library(here)
#### Read in the data ####
cleaned_data <-
  read_csv(
    file = here::here("data","analysis_data", "analysis_data.csv"),
    show_col_types = FALSE
  )
```

```{r}
#| label: fig-bills
#| fig-cap: Bills of penguins
#| echo: false
library(dplyr)
library(knitr)
library(kableExtra)
selected_data <- cleaned_data %>%
  filter(collection_date == as.Date("2024-09-01")) %>%
  select(Name, collection_date, e_coli, site_name)
kable(selected_data, col.names = c("Beach_Name", "Date", "E.coli", "Site_Name")) %>%
  kable_styling() %>%
  row_spec(0, bold = TRUE) %>%
  row_spec(0, extra_css = "border-bottom: 2px solid black;")  
```

```{r}
#| label: fig-planes
#| fig-cap: Relationship between wing length and width
#| echo: false
#| warning: false
#| message: false

library(ggplot2)
library(lubridate)

ggplot(cleaned_data, aes(x = collection_date, y = e_coli)) +
  geom_point() +
  labs(title = "Scatter Plot without Outliers")

```

## Basic Summary of cleaned Dataset
Figure 1 shows the attributes of the data, with most E. coli values being below 500, meaning there are 500 E. coli per 100 ml of water. However, the scatter plot also reveals that the data from 2020 stands out compared to other years, but a more precise graphical output is needed for a better understanding of the dataset. Therefore, in Table 2, a bar chart was used to show the total amount of valid data collected each year. It is clear that due to the COVID-19 pandemic, the data collected by Toronto Public Health in 2020 is significantly less compared to other years. Figure 2 also provides a calculation of the distribution of collected E. coli data. Based on Canada's water quality standard of 200 E. coli per 100 ml, about 78% of the data falls within this standard, meaning that approximately 78% of the days from 2007 to the present were safe for beach activities. However, based on Toronto's stricter standard of 100 E. coli per 100 ml, only around 60% of the data meets this standard, meaning that about 60% of the days were safe for beachgoers. However, considering the additional variables of location and date, it is not yet possible to draw a reasonable conclusion about the overall water quality. A more in-depth analysis will be conducted in Section 3.
```{r}
#| label: fig-1
#| fig-cap: Bills of penguins
#| echo: false

#### download the library ####
library(dplyr)
library(ggplot2)
#### draw the histogram ####
yearcountdata <- cleaned_data %>%
  mutate(year = format(as.Date(collection_date), "%Y")) %>%
  group_by(year) %>%
  summarize(datacount = n())
ggplot(yearcountdata, aes(x = year, y = datacount)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = datacount), vjust = -0.5, size = 3) +
  labs(title = "Number of observations by year", x ="Year", y = "Total observations each year") +
  theme_minimal()

```

```{r}
#| label: fig-2
#| fig-cap: Bills of penguins
#| echo: false

library(knitr)
library(kableExtra)
ecoli_distribution <- cleaned_data %>%
  mutate(ecoli_range = cut(e_coli, breaks = c(0, 50, 100, 200, Inf), right = FALSE,
                           labels = c("0-50", "50-100", "100-200", ">200"))) %>%
  group_by(ecoli_range) %>%
  summarize(count = n()) %>%
  mutate(percentage = (count / sum(count)) * 100)
kable(ecoli_distribution,
      col.names = c("E.Coli Levels", "Sample Count", "Portion"),
      caption = "Portion of E.Coli levels in different ranges") %>%
  kable_styling() %>%
  row_spec(0, bold = TRUE) %>%
  row_spec(0, extra_css = "border-bottom: 2px solid black;")  
```

## Dataset justification
The reason for choosing this dataset is that, during this summer, there were news reports about several incidents of people defecating on Toronto beaches, with even photos of the feces circulating. This caused some panic among people in Toronto who were planning to visit the beach. To verify whether the beach closures were indeed caused by these incidents and to reduce potential bias, as well as out of personal interest, this paper uses data published by Toronto Public Health. The dataset spans 18 years, from 2007 to the present, containing E. coli test results for beach water quality. It effectively reveals the trends in water quality over the years and helps to project future trends, reducing doubts about the validity of the analysis due to a small data sample.


# Result{#thi-data}

## Studying the relationship between time and E. coli concentration

```{r}
#| label: fig-3
#| fig-cap: Bills of penguins
#| echo: false

library(dplyr)
library(ggplot2)
avg_ecoli <- cleaned_data %>%
  mutate(year = format(as.Date(collection_date), "%Y")) %>%
  group_by(year) %>%
  summarize(avg_ecoli = mean(e_coli, na.rm = TRUE))
ggplot(avg_ecoli, aes(x = year, y = avg_ecoli)) + 
  geom_point() +
  labs(title = "Mean E.Coli levels by year", x = "Year", y = "Mean E.Coli") + 
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 60, vjust = 0.5, hjust = 1))
```

## Examing the portion of E.coli higher than the standard level by year

```{r}
#| label: fig-4
#| fig-cap: Bills of penguins
#| echo: false
library(dplyr)
library(ggplot2)
ecoli_portion <- cleaned_data %>%
  mutate(year = format(as.Date(collection_date), "%Y")) %>%
  group_by(year) %>%
  summarize(total_samples = n(),
            above200 = sum(e_coli > 200, na.rm = TRUE),
            proportion = above200 / total_samples * 100)
ggplot(ecoli_portion, aes(x = year, y = proportion)) + 
  geom_col(fill = "darkgrey") +
  labs(title = "Portion of higher than safe E.Coli level by year", 
       x = "Year", y = "Portion(%)")+
  theme_minimal()

```
## Investigating the relationship with E.coli and site location

```{r}
#| label: fig-5
#| fig-cap: Bills of penguins
#| echo: false
library(dplyr)
library(ggplot2)
avg_ecoli_site <- cleaned_data %>%
  group_by(site_name) %>%
  summarize(avg_ecoli = mean(e_coli, na.rm = TRUE))
ggplot(avg_ecoli_site, aes(x = site_name , y = avg_ecoli)) + 
  geom_point() +
  labs(title = "Mean E.Coli levels by each site", x = "Site", y = "Mean E.Coli") + 
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 60, vjust = 0.5, hjust = 1))
```

```{r}
#| label: fig-6
#| fig-cap: Bills of penguins
#| echo: false
library(dplyr)
library(knitr)
library(kableExtra)
ecoli_site_count <- cleaned_data %>%
  group_by(site_name) %>%
  summarize(total_samples = n(),
            above200 = sum(e_coli > 200, na.rm = TRUE),
            portion200 = above200 / total_samples * 100)

kable(ecoli_site_count,
      col.names = c("Site name", "Total Samples", "Above 200 count", "Portion(%)"),
      caption = "Portion of E.Coli levels above safe level in different site") %>%
  kable_styling() %>%
  row_spec(0, bold = TRUE) %>%
  row_spec(0, extra_css = "border-bottom: 2px solid black;")  
```


# Results

Our results are summarized in @tbl-modelresults.

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false

library(rstanarm)


```

```{r}
#| echo: false
#| eval: true
#| label: tbl-modelresults
#| tbl-cap: "Explanatory models of flight time based on wing width and wing length"
#| warning: false


```




# Discussion

## First discussion point {#sec-first-point}

If my paper were 10 pages, then should be be at least 2.5 pages. The discussion is a chance to show off what you know and what you learnt from all this. 

## Second discussion point

## Third discussion point

## Weaknesses and next steps

Weaknesses and next steps should also be included.

\newpage

\appendix

# Appendix {-}


# Additional data details

# Model details {#sec-model-details}

## Posterior predictive check

In @fig-ppcheckandposteriorvsprior-1 we implement a posterior predictive check. This shows...

In @fig-ppcheckandposteriorvsprior-2 we compare the posterior with the prior. This shows... 

```{r}
#| eval: true
#| echo: false
#| message: false
#| warning: false
#| label: fig-ppcheckandposteriorvsprior
#| layout-ncol: 2
#| fig-cap: "Examining how the model fits, and is affected by, the data"
#| fig-subcap: ["Posterior prediction check", "Comparing the posterior with the prior"]


```

## Diagnostics

@fig-stanareyouokay-1 is a trace plot. It shows... This suggests...

@fig-stanareyouokay-2 is a Rhat plot. It shows... This suggests...

```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-stanareyouokay
#| fig-cap: "Checking the convergence of the MCMC algorithm"
#| fig-subcap: ["Trace plot", "Rhat plot"]
#| layout-ncol: 2

```



\newpage


# References


